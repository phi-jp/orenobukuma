<!doctype html>
 
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    
    <title>Firebase</title>
    <meta name="description" content="思いたったらすぐ開発. プログラミングに革命を..." />
    
    <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
    
    <script src='https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.js'></script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/jade/1.11.0/jade.js'></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/less.js/2.2.0/less.min.js"></script>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/riot/2.3.13/riot+compiler.js'></script>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.js'></script>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.5/css/materialize.css' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.5/js/materialize.js'></script>

    <style>
    body {
      background-color: hsl(0, 0%, 95%);
    }
    </style>

  </head>
  <body>
    <app></app>
  </body>
</html>

<script src='util.js'></script>

<script type="riot/tag" template='jade'>
app
  header
  content
  footer
  
  script.
    this.on('mount', function() {
      riot.route.start();

      riot.route(function(path, query) {
        var tag = path[0];

        if (!tag) {
          tag = 'home';
        }

        var pages = ['login', 'signup', 'users', 'home', 'links'];
        if (pages.indexOf(tag) === -1) {
          console.log(tag, 'to', 'user');
          tag = 'user';
        }

        riot.mount('content', tag, {
          path: path,
          query: query,
        });
      });

      var hash = location.hash.replace('#', '');
      if (hash) {
        riot.route.exec();
      }
      // riot.route(hash || 'home');
    });

    this.msg = 'Hello, Riot.js';

header
  nav.light-blue.lighten-1
    div.row
      div.col.s12
        div.brand-logo
          a(href='#home') オレのブクマ
        ul.right(if='{!isLogin()}')
          li
            a(onclick='{login}') Login
          li
            a(onclick='{signup}') Signup
        ul.right(if='{isLogin()}')
          li
            a(href='#users') Users
          li
            a(href='#links') Links
          li
            a(onclick='{logout}') Logout
  script.
    this.login = function() {
      riot.route('login');
    };
    this.signup = function() {
      riot.route('signup');
    };
    this.logout = function() {
      window.authData = null;
      ref.unauth();
      riot.route('login');
    };

    this.isLogin = function() {
      return !!window.authData;
    };

// # link
item
  div.z-depth-2.item
    div.row
      div.col.s4
        div.image
          img(src='http://s.wordpress.com/mshots/v1/{url}?w=320')
        // img(src='http://capture.heartrails.com/320x240/delay=2?{url}')

      div.col.s8.content
        div.main
          a.title.grey-text.text-darken-4(href='{url}') {title}
          p {note}
        div.action.right-align
          button.btn(onclick='{del}') del
          button.btn(onclick='{edit}') edit

  style(scoped, type='less').

    .item {
      background-color: white;
    }

    .image {
      // background-color: red;
      img {
        width: 100%;
      }
    }
    .content {
      position: relative;
      height: 200px;
      .main {
        padding: 0.5rem;
        .title {
          font-size: 1.4rem;
        }
      }
      .action {
        position: absolute;
        bottom: 0px;
        width: 100%;
        padding: 0.5rem;
        padding-right: 2rem;
      }
    }
    // .card {
    //   .card-image {
    //     padding: 4px;
    //     background-color: hsl(0, 0%, 37%);
    //   }
    //   .card-content {
    //     .card-title {
    //       white-space: nowrap;
    //       // margin: 0px;
    //       // padding: 0px;
    //       line-height: 1;
    //     }
    //     height: 100px;
    //   }
    // }
  script.
    this.edit = function() {

    };
    this.del = function() {
      var users = ref.child('links').child(this.id).child('users');
      users.child(authData.uid).remove();

      ref.child('users').child(authData.uid).child('links').child(this.id).remove();
    };

// # home
home
  div.container
    h2 {user.name} だよー
    p {user.description}
    input(name='link', value='http://phiary.me')
    button.btn(onclick='{onadd}') add
    div.row
      div.col.s12(each='{links}')
        item
  script.

    var self = this;
    this.links = [];

    var userLinks = ref.child('users').child(authData.uid).child('links');

    userLinks.on('value', function(snapshot) {
      snapshot.forEach(function(link) {
        ref.child('links').child(link.key()).on('value', function(linkSnapshot) {
          var d = linkSnapshot.val();
          d['id'] = linkSnapshot.key();
          d['note'] = link.val().note;
          d['timestamp'] = link.val().timestamp;
          self.links.push(d);
          riot.update();
        });
      });
    }.bind(this));

    this.onadd = function() {
      var url = this.link.value;

      getTitle(url, function(data) {
        self.add(url, data.title);
      });
    };

    this.add = function(url, title) {
      var link = ref.child('links').push({
        title: title,
        url: url,
        uid: authData.uid,
        timestamp: Date.now(),
      });

      link.child('users').child(authData.uid).set(true);

      var userLinks = ref.child('users').child(authData.uid).child('links');
      userLinks.child(link.key()).set({
        note: '',
        timestamp: Date.now(),
      });
    };

// # user
user
  div.container
    h2 {username} のページだよ
    p {user.description}

    ul
      li(each='{links}')
        a(href='{url}', target='_blank') {url}

  script.
    var self = this;
    this.links = [];
    this.username = opts.path[0];

    ref.child('users').orderByChild('name').equalTo(this.username).on('child_added', function(snapshot) {
      self.user = snapshot.val();
      self.update();

      snapshot.child('links').forEach(function(link) {
        ref.child('links').child(link.key()).on('value', function(snapshot) {
          self.links.push(snapshot.val());
          self.update();
        });
      });
    });

users
  div.container
    h2 users です!

    ul
      li(each='{users}')
        a(href='\#{name}') {name}
        | 
        span {description}
  script.

    this.users = [];

    ref.child('users').on('child_added', function(snapshot) {
      this.users.push(snapshot.val());
      this.update();
    }.bind(this));


links
  div.container
    h2 links です!

    ul
      li(each='{links}')
        a(href='\#{url}') {url}
        | 
        span {description}
  script.

    this.links = [];

    ref.child('links').on('child_added', function(snapshot) {
      this.links.push(snapshot.val());
      this.update();
    }.bind(this));

signup
  div.container
    form(onsubmit='{signup}')
      h2 Signup
      div
        input(name='email', type='text', placeholder='email')
      div
        input(name='password', type='password', placeholder='password')
      div.right
        button.btn signup
  script.
    this.signup = function() {
      ref.createUser({
        email: this.email.value,
        password: this.password.value,
      }, function(error, authData) {
        if (error) {
          switch (error.code) {
            case 'EMAIL_TOKEN':
              console.log("The new user account cannot be created because the email is already in use.");
              break;
            case 'INVALID_EMAIL' :
              console.log("The specified email is not a valid email.");
              break;
            default :
              console.log("Error creating user:", error);
          }
        }
        else {
          console.log("Successfully created user account with uid:", authData.uid);
        }
      });
    };
// login
login
  div.container
    form(onsubmit='{login}')
      h2 Login
      div
        input(name='email', type='text', placeholder='email')
      div
        input(name='password', type='password', placeholder='password')
      div.right
        button.btn login
  script.
    this.login = function() {
      ref.authWithPassword({
        email: this.email.value,
        password: this.password.value,
      }, function(error, authData) {
        window.authData = authData;
        riot.route('home');
      });
    };

</script>

<script>
riot.route.parser(function(path) {
  var raw = path.split('?');
  var hashes = raw[0].split('/');
  var qs = raw[1];
  var params = {};

  if (qs) {
    qs.split('&').forEach(function(v) {
      var c = v.split('=');
      params[c[0]] = c[1];
    });
  }

  return [hashes, params];
});

var ref = new Firebase("https://orenobukuma.firebaseio.com/");
ref.onAuth(function(authData) {
  if (authData) {
    console.log("User " + authData.uid + " is logged in with " + authData.provider);
    window.authData = authData;

    ref.child('users').child(authData.uid).on('value', function(snapshot) {
      window.user = snapshot.val();
      var tags = riot.mount('*');
    });

    // create user
    // ref.child('users').child(authData.uid).set({
    //   name: 'phi',
    //   description: 'Hello, world!',
    //   url: 'http://phairy.me',
    // });
  }
  else {
    console.log("User is logged out");
    var tags = riot.mount('*');
  }
});

</script>
